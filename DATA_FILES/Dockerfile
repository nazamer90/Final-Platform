# ==========================================
# ğŸš€ MULTI-STAGE DOCKERFILE FOR FLY.IO
# ==========================================
# Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ¨Ù†ÙŠ ØµÙˆØ±Ø© Docker Ù…ÙØ­Ø³Ù‘Ù†Ø© Ù„Ù„Ù€ Backend

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: BUILD STAGE
# ==========================================
FROM node:18-alpine AS builder

# ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
WORKDIR /app

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª package Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Docker cache
COPY package*.json ./

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ÙÙ‚Ø· Ù„Ù„Ø¥Ù†ØªØ§Ø¬
RUN npm ci --only=production --omit=dev

# Ù†Ø³Ø® Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
COPY . .

# Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¥Ø°Ø§ ÙƒØ§Ù† TypeScript)
RUN if [ -f "tsconfig.json" ]; then \
    npm install --save-dev typescript @types/node && \
    npm run build; \
    fi

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: PRODUCTION STAGE
# ==========================================
FROM node:18-alpine

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
RUN apk add --no-cache \
    ca-certificates \
    tzdata

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø£Ù…Ø§Ù†)
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
WORKDIR /app

# Ù†Ø³Ø® node_modules Ù…Ù† Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules

# Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ© Ø£Ùˆ Ø§Ù„Ø£ØµÙ„ÙŠØ©
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./

# Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù„Ù dist (TypeScript Ù…Ø¨Ù†ÙŠ)
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist 2>/dev/null || true

# Ø¥Ø°Ø§ ÙƒØ§Ù† JavaScript Ù…Ø¨Ø§Ø´Ø±
COPY --from=builder --chown=nodejs:nodejs /app/*.js ./ 2>/dev/null || true
COPY --from=builder --chown=nodejs:nodejs /app/app.ts ./app.ts 2>/dev/null || true
COPY --from=builder --chown=nodejs:nodejs /app/index.ts ./index.ts 2>/dev/null || true

# Ù†Ø³Ø® Ù…Ù„Ù server.js Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
COPY --chown=nodejs:nodejs server.js ./server.js 2>/dev/null || true

# Ù†Ø³Ø® Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
COPY --from=builder --chown=nodejs:nodejs /app/public ./public 2>/dev/null || true
COPY --from=builder --chown=nodejs:nodejs /app/backend ./backend 2>/dev/null || true

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª uploads Ùˆ logs
RUN mkdir -p /app/uploads /app/logs && \
    chown -R nodejs:nodejs /app/uploads /app/logs

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER nodejs

# ÙØªØ­ Ø§Ù„Ù…Ù†ÙØ° 8080
EXPOSE 8080

# Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ù…Ù†ÙØ°
ENV PORT=8080
ENV NODE_ENV=production

# ==========================================
# ğŸš€ STARTUP COMMAND
# ==========================================
# ÙŠØ­Ø§ÙˆÙ„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¹Ø¯Ø© Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©

CMD if [ -f "dist/index.js" ]; then \
        node dist/index.js; \
    elif [ -f "backend/dist/index.js" ]; then \
        node backend/dist/index.js; \
    elif [ -f "server.js" ]; then \
        node server.js; \
    elif [ -f "index.js" ]; then \
        node index.js; \
    elif [ -f "app.js" ]; then \
        node app.js; \
    else \
        echo "âŒ No entry point found!" && exit 1; \
    fi

# ==========================================
# ğŸ“ BUILD INSTRUCTIONS:
# ==========================================
# Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:
# docker build -t eishro-backend .
#
# Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:
# docker run -p 8080:8080 --env-file .env.fly.production eishro-backend
#
# Ø¹Ù„Ù‰ Fly.io:
# fly deploy (ÙŠØ¨Ù†ÙŠ ÙˆÙŠØ±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
