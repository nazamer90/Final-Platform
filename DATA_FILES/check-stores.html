<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<script type="text/javascript">
  // This is a CodeSandbox injection script that's used to
  // add navigation and inspector functionality to the preview
  (function () {
    // 1) Get the <script> tag that's currently running:
    var me = document.currentScript;

    // 2) Create the blockingâ€style <script> to load:
    var script = document.createElement("script");
    script.src = "https://codesandbox.io/p/preview-protocol.js";

    // By default a dynamicallyâ€inserted <script> is async=true.
    // Turn async off to make it behave like a normal blocking <script>:
    script.async = false;
    // (Do NOT set defer.)

    // 3) Insert it immediately after the current <script>:
    me.parentNode.insertBefore(script, me);
  })();

  const isIFramePreview = window.top !== window.self;

  // Only run this script in editor context
  if (isIFramePreview) {
    // This script is used to enable Chrome DevTools functionality
    (function () {
      var script = document.createElement("script");
      script.src =
        "https://codesandbox.io/p/chrome-devtool/protocol/index.js";

      script.onload = () => {
        const devtoolProtocol = window.chobitsu;
        if (devtoolProtocol) {
          window.addEventListener("message", (event) => {
            const { type, data } = event.data;

            if (type === "FROM_DEVTOOL") {
              devtoolProtocol.sendRawMessage(data);
            }
          });

          devtoolProtocol.setOnMessage((data) => {
            if (data.includes('"id":"tmp')) {
              return;
            }

            window.parent.postMessage({ type: "TO_DEVTOOL", data }, "*");
          });

          devtoolProtocol.sendRawMessage(
            `{"id":5,"method":"Runtime.enable","params":{}}`
          );
        }        
      }

      (document.head || document.documentElement).prepend(script);
    })();
  }

  if (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ === "undefined") {
    let nextID = 0;
    let hook = (__REACT_DEVTOOLS_GLOBAL_HOOK__ = {
      renderers: new Map(),
      supportsFiber: true,
      inject: (renderer) => {
        const id = nextID++;
        hook.renderers.set(id, renderer);
        return id;
      },
      onScheduleFiberRoot() {},
      onCommitFiberRoot() {},
      onCommitFiberUnmount() {},
    });
  }

  document.currentScript.remove();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ­Øµ Ø§Ù„Ù…ØªØ§Ø¬Ø±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-btn:hover {
            transform: none;
            box-shadow: none;
            background: #e0e0e0;
        }
        
        .tab-btn.active:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-display {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .info-box {
            background: #e3f2fd;
            border-right: 4px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #1565c0;
        }
        
        .success-box {
            background: #c8e6c9;
            border-right: 4px solid #4caf50;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #2e7d32;
        }
        
        .error-box {
            background: #ffcdd2;
            border-right: 4px solid #f44336;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #c62828;
        }
        
        .storage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .copy-btn {
            padding: 8px 16px;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ÙØ­Øµ Ø§Ù„Ù…ØªØ§Ø¬Ø±</h1>
            <button onclick="window.location.href='admin-tools.html'">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(0)">ğŸ“± localStorage</button>
            <button class="tab-btn" onclick="switchTab(1)">ğŸ—„ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="tab-btn" onclick="switchTab(2)">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button class="tab-btn" onclick="switchTab(3)">ğŸ”§ JSON Ø®Ø§Ù…</button>
        </div>
        
        <div class="content">
            <!-- Tab 0: localStorage -->
            <div class="tab-content active">
                <div class="storage-stats" id="localStats"></div>
                <button class="copy-btn" onclick="copyToClipboard('localData')">ğŸ“‹ Ù†Ø³Ø®</button>
                <div class="data-display" id="localData"></div>
            </div>
            
            <!-- Tab 1: Database -->
            <div class="tab-content">
                <button class="copy-btn" onclick="copyToClipboard('dbData')">ğŸ“‹ Ù†Ø³Ø®</button>
                <div class="data-display" id="dbData"></div>
            </div>
            
            <!-- Tab 2: Statistics -->
            <div class="tab-content">
                <div id="statsContent"></div>
            </div>
            
            <!-- Tab 3: Raw JSON -->
            <div class="tab-content">
                <button class="copy-btn" onclick="copyToClipboard('jsonData')">ğŸ“‹ Ù†Ø³Ø®</button>
                <div class="data-display" id="jsonData"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:4000/api/stores';
        
        function switchTab(index) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.querySelectorAll('.tab-content')[index].classList.add('active');
            document.querySelectorAll('.tab-btn')[index].classList.add('active');
            
            if (index === 0) loadLocalStorage();
            else if (index === 1) loadDatabase();
            else if (index === 2) loadStatistics();
            else if (index === 3) loadRawJSON();
        }
        
        function loadLocalStorage() {
            const data = {};
            let storeCount = 0;
            let fileCount = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eshro_')) {
                    try {
                        data[key] = JSON.parse(localStorage.getItem(key));
                        if (key === 'eshro_stores') storeCount = (data[key] || []).length;
                        else if (key.startsWith('eshro_store_files_')) fileCount++;
                    } catch (e) {
                        data[key] = localStorage.getItem(key);
                    }
                }
            }
            
            document.getElementById('localStats').innerHTML = `
                <div class="stat">
                    <div class="stat-number">${storeCount}</div>
                    <div class="stat-label">Ù…ØªØ§Ø¬Ø± ÙÙŠ eshro_stores</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${fileCount}</div>
                    <div class="stat-label">Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø¬Ø±</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${Object.keys(data).length}</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØ§ØªÙŠØ­</div>
                </div>
            `;
            
            document.getElementById('localData').textContent = JSON.stringify(data, null, 2);
        }
        
        async function loadDatabase() {
            const container = document.getElementById('dbData');
            container.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            
            try {
                const response = await fetch(`${API_URL}/list`);
                if (response.ok) {
                    const data = await response.json();
                    container.textContent = JSON.stringify(data, null, 2);
                } else {
                    container.textContent = `âŒ Ø®Ø·Ø£: ${response.status} ${response.statusText}\n\nÙ‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø®Ø§Ø¯Ù… Ù…ØªØ§Ø­Ø§Ù‹ Ø¹Ù„Ù‰ ${API_URL}`;
                }
            } catch (error) {
                container.textContent = `âŒ Ø®Ø·Ø£ Ø§Ù„Ø§ØªØµØ§Ù„:\n${error.message}\n\nØ§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­ Ø¹Ù„Ù‰ ${API_URL}`;
            }
        }
        
        function loadStatistics() {
            let storesData = [];
            let stats = {
                totalStores: 0,
                activeStores: 0,
                inactiveStores: 0,
                storesWithLogo: 0,
                storesWithPhone: 0,
                storesWithEmail: 0
            };
            
            // Load from eshro_stores
            try {
                const stores = JSON.parse(localStorage.getItem('eshro_stores') || '[]');
                if (Array.isArray(stores)) storesData = stores;
            } catch (e) {}
            
            // Load from eshro_store_files_*
            if (storesData.length === 0) {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('eshro_store_files_')) {
                        try {
                            const storeFiles = JSON.parse(localStorage.getItem(key) || '{}');
                            if (storeFiles.storeData) {
                                storesData.push(storeFiles.storeData);
                            }
                        } catch (e) {}
                    }
                }
            }
            
            stats.totalStores = storesData.length;
            stats.activeStores = storesData.filter(s => s.active !== false).length;
            stats.inactiveStores = stats.totalStores - stats.activeStores;
            stats.storesWithLogo = storesData.filter(s => s.logo || s.storeLogo).length;
            stats.storesWithPhone = storesData.filter(s => s.phone || s.ownerPhone || s.warehousePhone).length;
            stats.storesWithEmail = storesData.filter(s => s.email || s.ownerEmail).length;
            
            document.getElementById('statsContent').innerHTML = `
                <div class="success-box">âœ… ØªÙ… Ø¬Ù…Ø¹ ${stats.totalStores} Ù…ØªØ¬Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ</div>
                
                <div class="storage-stats">
                    <div class="stat">
                        <div class="stat-number">${stats.totalStores}</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ§Ø¬Ø±</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${stats.activeStores}</div>
                        <div class="stat-label">Ù…ØªØ§Ø¬Ø± Ù†Ø´Ø·Ø©</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${stats.inactiveStores}</div>
                        <div class="stat-label">Ù…ØªØ§Ø¬Ø± Ù…Ø¹Ø·Ù„Ø©</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${stats.storesWithLogo}</div>
                        <div class="stat-label">Ù„Ù‡Ø§ Ø´Ø¹Ø§Ø±</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${stats.storesWithPhone}</div>
                        <div class="stat-label">Ù„Ù‡Ø§ Ù‡Ø§ØªÙ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${stats.storesWithEmail}</div>
                        <div class="stat-label">Ù„Ù‡Ø§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
                    </div>
                </div>
                
                <h3 style="margin-top:30px;margin-bottom:15px;color:#333;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø¬Ø±:</h3>
                ${storesData.map((s, i) => `
                    <div class="info-box">
                        ${i + 1}. <strong>${s.nameAr || s.storeName || s.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong>
                        <br>Ø§Ù„Ø­Ø§Ù„Ø©: ${s.active === false ? 'âŒ Ù…Ø¹Ø·Ù„' : 'âœ… Ù†Ø´Ø·'}
                        <br>Ø§Ù„Ø¨Ø±ÙŠØ¯: ${s.email || s.ownerEmail || '-'}
                        <br>Ø§Ù„Ù‡Ø§ØªÙ: ${s.phone || s.ownerPhone || '-'}
                        <br>Ø§Ù„Ù…Ø¬Ø§Ù„: ${s.subdomain || s.storeSlug || s.slug || '-'}
                    </div>
                `).join('')}
            `;
        }
        
        function loadRawJSON() {
            const allData = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eshro_')) {
                    try {
                        allData[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        allData[key] = localStorage.getItem(key);
                    }
                }
            }
            
            document.getElementById('jsonData').textContent = JSON.stringify(allData, null, 2);
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
        
        loadLocalStorage();
    </script>
</body>
</html>
